#+PROPERTY: header-args :session *R* :tangle ../docs/R/physical.R :eval no-export
#+OPTIONS: ^:nil

#+begin_src R :exports none :tangle no
setwd('~/github/bookvis')
#+end_src

#+begin_src R :exports none  
##################################################################
## Initial configuration
##################################################################
## Clone or download the repository and set the working directory
## with setwd to the folder where the repository is located.
  
#+end_src

* Introduction
label:sec:physical

#+begin_src R :exports none
##################################################################
## Physical maps
##################################################################
#+end_src

Brazil[fn:1], the world's fifth largest country, is one of the
seventeen megadiverse countries[fn:2], home to diverse wildlife,
natural environments, and extensive natural resources in a variety of
protected habitats. Throughout this section we will create a physical
map of this exceptional country using data from several data services.

** Packages

#+INDEX: Packages!raster@\texttt{raster}  
#+INDEX: Packages!rasterVis@\texttt{rasterVis}  
#+INDEX: Packages!sp@\texttt{sp}  
#+INDEX: Packages!colorspace@\texttt{colorspace}  

#+begin_src R 
library("lattice")
library("ggplot2")
library("latticeExtra")

library("terra")
library("sp")
library("sf")

library("rnaturalearth")
library("rnaturalearthhires")
library("geodata")

library("rasterVis")
library("tidyterra")

library("colorspace")
library("RColorBrewer")

library("ggrepel")
#+end_src

* Retrieving Data
#+begin_src R :exports none
##################################################################
## Retrieving data from DIVA-GIS, GADM and Natural Earth Data
##################################################################
#+end_src
Three types of information are needed: administrative boundaries,
terrain elevation, and rivers and lakes.

#+INDEX: Data!GADM
#+INDEX: Data!DIVA-GIS
#+INDEX: Data!Natural Earth Data
#+INDEX: Packages!geodata@\texttt{geodata}
#+INDEX: Packages!rnaturalearth@\texttt{rnaturalearth}

  1. The administrative boundaries are available from Natural
     Earth[fn:3] with the packages =rnaturalearth= and
     =rnaturalearthhires=[fn:4].
     #+begin_src R :eval no-export

     brazilAdm <- ne_states(country = "brazil")
     #+end_src

  2. The terrain elevation or digital elevation model (DEM) is
     available from DIVA-GIS service[fn:5] with the =geodata= package,
     obtaining a =SpatRaster= object.
     #+begin_src R :eval no-export
     brazilDEM <- elevation_30s("BRA", mask = FALSE,
                                path = tempdir())
     #+end_src
  3. The water lines (rivers and lakes) are available from Natural
     Earth Data. 
     #+begin_src R :eval no-export
     worldRiv <- ne_download(type = "rivers_lake_centerlines",
                             category = "physical", 
                             scale = 10)
     #+end_src
     The rivers and lakes database from Natural Earth Data comprises
     all the world extent, but we only need the rivers of Brazil. The
     function =st_crop= of the package =sf= determines the
     intersection between two objects.
     #+begin_src R :eval no-export
     ## only those features labeled as "River" are needed
     worldRiv <- worldRiv[worldRiv$featurecla == "River",]

     ## Ensure the CRS of brazilDEM matches the CRS of worldRiv
     crs(brazilDEM) <- crs(worldRiv)

     ## and intersect it with worldRiv to extract brazilian rivers
     ## from the world database
     brazilRiv <- st_crop(worldRiv, brazilDEM)
     #+end_src

* Labels
#+begin_src R :exports none
##################################################################
## Labels
##################################################################
#+end_src

Each region of Brazil will be labeled with the name of its
corresponding polygon. The locations of the labels are defined by the
=latitude= and =longitude= values included in the =sf= object. In
addition, a larger label with the name of the country will be placed
in the average centroid.

#+begin_src R
## Locations of labels of each polygon
centroids <- brazilAdm[ , c("longitude", "latitude")]
## Extract the data
centroids <- st_drop_geometry(centroids)
## Location of the "Brazil" label (average of the centroids)
xyBrazil <- apply(centroids, 2, mean)
#+end_src

Some region names are too long to be displayed in one line. Thus, a
previous step is to split the string if it comprises more than two
words.

#+begin_src R 
admNames <- strsplit(as.character(brazilAdm$name), ' ')
  
admNames <- sapply(admNames,
                   FUN = function(s){
                       sep = if (length(s)>2) '\n' else  ' '
                       paste(s, collapse = sep)
                   })
#+end_src

* Overlaying Layers of Information
#+begin_src R :exports none
##################################################################
## Overlaying layers of information
##################################################################
#+end_src

Therefore, the physical map is composed of three layers: the altitude
raster layer, the rivers defined by the =brazilRiv= object, and the
administrative boundaries defined by the =brazilAdm= object and their
labels (=admNames= and =centroids=).

The altitude raster layer can be displayed with the =levelplot=
function of the =rasterVis= package (=lattice= version) or with the
=geom_spatraster= function of the =tidyterra= package (=ggplot2=
version).

With =levelplot= we use a terrain colors palette, as the one produced
by the =terrain_hcl= function from the =colorspace= package
cite:Ihaka.Murrell.ea2016. The theme for the graphic is configured via
=rasterTheme= with this palette and setting the background (=NA=
values) to a light blue (Figure ref:fig:brazilDEMlattice).

#+begin_src R
terrainTheme <- rasterTheme(region = terrain_hcl(15),
                            panel.background = list(col = "lightskyblue1"))

altPlot <- levelplot(brazilDEM, par.settings = terrainTheme,
                     maxpixels = 1e6, panel = panel.levelplot.raster,
                     margin = FALSE, colorkey = FALSE)
#+end_src

#+begin_src R :results output graphics file :exports results :file figs/Spatial/brazilDEMlattice.png :width 2000 :height 2000 :res 300
print(altPlot)
#+end_src


The =tidyterra= package includes multiple palettes[fn:6] that are well
suited for representation of digital elevation models. For example,
the =scale_fill_whitebox_c= function encodes palettes from the
WhiteBox project[fn:7], of which I have chosen the =high_relief= one
(Figure ref:fig:brazilDEMGG).

#+begin_src R :results output graphics file :exports both :file figs/Spatial/brazilDEMGG.png :width 2000 :height 2000 :res 300
ggplot() +
  geom_spatraster(data = brazilDEM,
                  show.legend = FALSE) +
  scale_fill_whitebox_c("high_relief",
                        na.value = "aquamarine") +
  theme_bw()
#+end_src

#+CAPTION: Digital elevation model of Brazil. label:fig:brazilDEM
#+begin_figure
#+CAPTION: =lattice= version label:fig:brazilDEMlattice
#+attr_latex: :options {0.4\textheight}
#+begin_subfigure
#+attr_latex: :height 0.4\textheight 
#+RESULTS:
[[file:figs/Spatial/brazilDEMlattice.png]]
#+end_subfigure

#+CAPTION: =ggplot2= version label:fig:brazilDEMGG
#+attr_latex: :options {0.4\textheight}
#+begin_subfigure
#+attr_latex: :height 0.4\textheight 
#+RESULTS:
[[file:figs/Spatial/brazilDEMGG.png]]
#+end_subfigure
#+end_figure

Under the =lattice= framework, the rivers can be represented with the
=sp.lines= function of the =sp= package and superimposed over the DEM
map with the =layer= mechanism of the =latticeExtra= package. First,
=brazilRiv= must be converted to a =SpatialLines= object.
#+begin_src R
brazilRivsp <- as_Spatial(brazilRiv)
#+end_src
On the =ggplot2= side the =geom_sf= function of the =sf= package
displays the =brazilRiv= without a previous conversion.

Then, the =brazilAdm= object must be converted to a
=SpatialPolygons= object to be displayed with =sp.polygons= and
=lattice=, while the =geom_sf= function can use this object
directly. 

#+begin_src R
brazilAdmsp <- as_Spatial(brazilAdm)
#+end_src

Finally, the labels will be printed with =panel.text= for the
=lattice= version and with the =geom_text_repel= function of the
=ggrepel= package[fn:8], to repel overlapping text labels, for the
=ggplot2= version.

The final result is shown in Figure ref:fig:brazil.

#+begin_src R :results output graphics file :exports both :file figs/Spatial/brazilLattice.png :width 2000 :height 2000 :res 300
## lattice version
altPlot + layer({
  ## Rivers
  sp.lines(brazilRivsp, col = 'darkblue', lwd = 0.2)
  ## Administrative boundaries
  sp.polygons(brazilAdmsp, col = 'black', lwd = 0.2)
  ## Centroids of administrative boundaries ...
  panel.points(centroids, col = 'black')
  ## ... with their labels
  panel.text(centroids, labels = admNames, pos = 3,
             cex = 0.7, fontfamily = 'Palatino', lineheight=.8)
  ## Country name
  panel.text(xyBrazil[1], xyBrazil[2], label = 'B R A Z I L',
             cex = 1.5, fontfamily = 'Palatino', fontface = 2)
  })
#+end_src


#+begin_src R :results output graphics file :exports both :file figs/Spatial/brazilGG.png :width 2000 :height 2000 :res 300
## ggplot2 version
ggplot() +
  geom_spatraster(data = brazilDEM,
                  show.legend = FALSE) +
  scale_fill_whitebox_c("high_relief",
                        na.value = "aquamarine") +
  geom_sf(data = brazilAdm,
          col = "black",
          linewidth = 0.15,
          fill = "transparent") +
  geom_sf(data = brazilRiv,
          col = "darkblue",
          linewidth = 0.1) +
  geom_point(data = centroids,
                     aes(x = longitude,
                         y = latitude)) +
  geom_text_repel(data = centroids,
                          aes(x = longitude,
                              y = latitude,
                              label = admNames),
                  family = "Palatino") +
  geom_text(aes(xyBrazil[1], xyBrazil[2],
                label = 'B R A Z I L'),
            size = 7,
            family = 'Palatino') +
  theme_bw()
#+end_src

#+CAPTION: Physical map of Brazil. Main administrative regions are labeled. label:fig:brazil
#+begin_figure
#+CAPTION: =lattice= version label:fig:brazilLattice
#+attr_latex: :options {0.4\textheight}
#+begin_subfigure
#+attr_latex: :height 0.4\textheight 
#+RESULTS:
[[file:figs/Spatial/brazilLattice.png]]
#+end_subfigure
#+CAPTION: =ggplot2= version label:fig:brazilGG
#+attr_latex: :options {0.4\textheight}
#+begin_subfigure
#+attr_latex: :height 0.4\textheight 
#+RESULTS:
[[file:figs/Spatial/brazilGG.png]]
#+end_subfigure
#+end_figure

* Footnotes

[fn:8]https://ggrepel.slowkow.com/ 
[fn:7]https://www.whiteboxgeo.com/ 

[fn:6]https://dieghernan.github.io/tidyterra/articles/palettes.html 
[fn:1] http://en.wikipedia.org/wiki/Brazil

[fn:2] http://en.wikipedia.org/wiki/Megadiverse_countries

[fn:3] http://www.naturalearthdata.com/

[fn:4] The package =rnaturalearthhires= is not available at CRAN due to its size. More information: https://docs.ropensci.org/rnaturalearthhires/  

[fn:5] https://www.diva-gis.org/

* COMMENT Local Variables
Local Variables:
ispell-local-dictionary: "british"
End:
